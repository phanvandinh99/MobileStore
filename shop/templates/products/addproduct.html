{% extends 'admin/layout.html' %}
{% block content %}
{%include 'admin/header.html'%}
<div class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{url_for('admin_manager')}}">Home</a></li>
                        <li class="breadcrumb-item active">Products</li>
                    </ol>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>
    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-2"></div>
                <!-- left column -->
                <div class="col-md-8">
                    <!-- general form elements -->
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">Thêm Mới Sản Phẩm</h3>
                        </div>
                        <!-- /.card-header -->
                        <!-- form start -->
                        {% from "_formhelpers.html" import render_field %}

                        <form method="post" enctype="multipart/form-data">
                            {{ form.csrf_token }}
                            <div class="card">
                                <div class="card-body">
                                    {% include '_messages.html'%}
                                    <div>
                                        {{ render_field(form.name, class="form-control") }}
                                        {{ render_field(form.price, class="form-control") }}
                                        {{ render_field(form.discount, class="form-control") }}
                                        {{ render_field(form.stock, class="form-control") }}
                                        <label for="category">Loại sản phẩm</label>
                                        <select name="category" id="category" class="form-control"
                                                onchange='myFunction()' required>
                                            <option value=""> Chọn loại sp</option>
                                            {% for category in categories %}
                                            <option value="{{category.id}}">{{category.name}}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <label for="brand">Thương Hiệu</label>
                                        <select name="brand" id="brand" class="form-control" required>
                                            <option value="">Chọn thương hiệu</option>
                                            {% for brand in brands %}
                                            <option value="{{brand.id}}">{{brand.name}}</option>
                                            {% endfor %}
                                        </select>

                                        {{ render_field(form.colors, class="form-control") }}
                                        {{ render_field(form.description, class="form-control", rows="10") }}

                                        <div class="container">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label for="image_1">Ảnh 1 <span style="color: red;">*</span></label>
                                                    <input type="file" name="image_1" id="image_1" class="form-control"
                                                           accept="image/*" required>
                                                    {% if form.image_1.errors %}
                                                        <div class="text-danger">
                                                            {% for error in form.image_1.errors %}
                                                                <small>{{ error }}</small>
                                                            {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="image_2">Ảnh 2 <span style="color: red;">*</span></label>
                                                    <input type="file" name="image_2" id="image_2" class="form-control"
                                                           accept="image/*" required>
                                                    {% if form.image_2.errors %}
                                                        <div class="text-danger">
                                                            {% for error in form.image_2.errors %}
                                                                <small>{{ error }}</small>
                                                            {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="image_3">Ảnh 3 <span style="color: red;">*</span></label>
                                                    <input type="file" name="image_3" id="image_3" class="form-control"
                                                           accept="image/*" required>
                                                    {% if form.image_3.errors %}
                                                        <div class="text-danger">
                                                            {% for error in form.image_3.errors %}
                                                                <small>{{ error }}</small>
                                                            {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div><!-- /.card -->
                            <div class="card-footer">
                                <button type="submit" class="btn btn-primary">Thêm Mới Sản Phẩm</button>
                            </div>
                        </form>
                        <!-- /.form-box -->

                        <!-- Image Preview Section -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h3 class="card-title">Xem trước ảnh</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        <div id="preview1" class="image-preview">
                                            <img id="img-preview1" src="" alt="Ảnh 1" style="max-width: 100%; max-height: 200px; display: none;">
                                            <div id="no-image1" class="no-image">Chưa chọn ảnh 1</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div id="preview2" class="image-preview">
                                            <img id="img-preview2" src="" alt="Ảnh 2" style="max-width: 100%; max-height: 200px; display: none;">
                                            <div id="no-image2" class="no-image">Chưa chọn ảnh 2</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <div id="preview3" class="image-preview">
                                            <img id="img-preview3" src="" alt="Ảnh 3" style="max-width: 100%; max-height: 200px; display: none;">
                                            <div id="no-image3" class="no-image">Chưa chọn ảnh 3</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.card -->
                </div>
                <!-- /.col-md-8 -->
            </div>
        </div>
    </section>
</div>

<script>
// Image preview functionality
document.getElementById('image_1').addEventListener('change', function(e) {
    previewImage(e.target, 'img-preview1', 'no-image1');
});

document.getElementById('image_2').addEventListener('change', function(e) {
    previewImage(e.target, 'img-preview2', 'no-image2');
});

document.getElementById('image_3').addEventListener('change', function(e) {
    previewImage(e.target, 'img-preview3', 'no-image3');
});

function previewImage(input, imgId, noImgId) {
    var img = document.getElementById(imgId);
    var noImg = document.getElementById(noImgId);

    if (input.files && input.files[0]) {
        var reader = new FileReader();

        reader.onload = function(e) {
            img.src = e.target.result;
            img.style.display = 'block';
            noImg.style.display = 'none';
        }

        reader.readAsDataURL(input.files[0]);
    } else {
        img.style.display = 'none';
        noImg.style.display = 'block';
    }
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    var image1 = document.getElementById('image_1').files[0];
    var image2 = document.getElementById('image_2').files[0];
    var image3 = document.getElementById('image_3').files[0];

    if (!image1 || !image2 || !image3) {
        e.preventDefault();
        alert('Vui lòng chọn đầy đủ 3 ảnh cho sản phẩm!');
        return false;
    }

    // Validate file types
    var allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    var files = [image1, image2, image3];

    for (var i = 0; i < files.length; i++) {
        if (files[i] && !allowedTypes.includes(files[i].type)) {
            e.preventDefault();
            alert('Chỉ chấp nhận file ảnh (JPG, PNG, GIF)!');
            return false;
        }
    }

    return true;
});

// Add CSS for image preview
var style = document.createElement('style');
style.innerHTML = `
    .image-preview {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 20px;
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .no-image {
        color: #999;
        font-style: italic;
    }
    .image-preview img {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
`;
document.head.appendChild(style);
</script>

{% include 'admin/footer.html' %}
<script>
function myFunction() {
     $("#brand option").remove();
     var newoptions = "<option value=''>Select a brand</option>";
     {% for brand in brands %}
     if(document.getElementById("category").value == {{brand.category_id}}){
        newoptions+="<option value='{{brand.id}}'>{{brand.name}}</option>";
     }
     {% endfor %}
     $("#brand").html(newoptions);
}

function validateForm() {
    var price = parseFloat(document.getElementById('price').value);
    var discount = parseInt(document.getElementById('discount').value) || 0;
    var stock = parseInt(document.getElementById('stock').value);
    
    // Validate price
    if (price <= 0) {
        alert('Giá không hợp lệ');
        document.getElementById('price').focus();
        return false;
    }
    
    // Validate discount
    if (discount < 0 || discount > 100) {
        alert('Giản giá từ 0 đến 100%');
        document.getElementById('discount').focus();
        return false;
    }
    
    // Validate stock
    if (stock < 0) {
        alert('Số lượng không hợp lệ');
        document.getElementById('stock').focus();
        return false;
    }
    
    return true;
}
</script>
{% endblock content %}